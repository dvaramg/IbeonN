<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë°°ì§€</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/main.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="logo"><a href="home.html">IbeonN</a></div>
    <nav>
      <span id="userWelcome" style="display: none;"></span>
      <a href="home.html">í™ˆ</a>
      <a href="dashboard.html">í™œë™ ëŒ€ì‹œë³´ë“œ</a>
      <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a href="badges.html">ë°°ì§€</a>
      
      <a href="login.html" id="loginLink">ë¡œê·¸ì¸</a>
      <button id="logoutBtn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
   </nav>
  </header>

  <main>
  <h2>ë‚´ NFT ë°°ì§€</h2>
  <ul id="recordsList" class="card-container">
  <p id="countInfo">ì°¸ì—¬ íšŸìˆ˜: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  <button id="connectBtn">ì§€ê°‘ ì—°ê²° í•˜ê¸°</button>
  <button id="getBadgeBtn">ìµœê·¼ ì°¸ì—¬ NFT ë±ƒì§€ ë°›ê¸°</button>
  <p id="status"> ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”</p>

  <script>
     window.onload = () => {
      const contractAddress = "0xd6bfC4A4e6B3151a8b2b2b3BDC294b42CE4C1c57";
      const abi = [
        "function mint(string memory tokenURI) public",
        "function nextTokenId() public view returns (uint256)"
      ];

      let provider, signer, contract;
      let currentAddress;

      document.getElementById("connectBtn").onclick = async () => {
        if (!window.ethereum) {
          alert("MetaMask not found!");
          return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const network = await provider.getNetwork();

        if (network.chainId !== 11155111) {
          alert("â— ì„¸í´ë¦¬ì•„ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°í•´ì£¼ì„¸ìš”!");
          return;
        }

        signer = provider.getSigner();
        const address = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, abi, signer);

        document.getElementById("status").textContent = `Connected: ${address}`;
        
        currentAddress = address; 
      };

      document.getElementById("getBadgeBtn").onclick = async () => {
        try {
          document.getElementById("status").textContent = "â³ Uploading & Minting...";

          const response = await fetch("/api/token-uri");
          const data = await response.json();
          const tokenURI = data.tokenURI;

          const tx = await contract.mint(tokenURI);
          await tx.wait();

          const tokenId = (await contract.nextTokenId()).toNumber() - 1;
          document.getElementById("status").innerHTML = `
            âœ… Minted!<br>
            ğŸ”— Token ID: ${tokenId}<br>
            
          `;
          
        } catch (err) {
          console.error(err);
          document.getElementById("status").textContent = "âŒ Mint failed.";
        }
      };
    };
  </script>
  </main>
</body>
</html>